<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <title>Jason Schwartzman</title>
    <link rel="icon" href="/images/JS.png"/>
</head>

<body>
    <header>
        <div style="position:fixed;z-index:9">
        <nav>
            <div class="button-container">
                <a href="/" class="button">Home</a>
                <div class="dropdown">
                    <a href="/projects" class="curbutton">Projects</a>
                    <div class="dropdown-content">
                        <a href="/projects/compiler">Compiler</a>
                        <a href="/projects/chess">Chess</a>
                        <a href="/projects/malware-analysis">Malware Analysis</a>
                        <a href="/projects/geo-spoofing-detection">Geo-Spoofing Detection</a>
                        <a href="/projects/personal-website">Personal Website</a>
                        <a href="/projects/code-injection">Code Injection</a>
                    </div>
                </div>
                <a href="/jlang" class="button">JLang</a>
                <a href="/skills" class="button">Skills</a>
                <a href="/contact" class="button">Contact</a>
            </div>
        </nav></div><div>
        <nav>
            <div style="margin-top:53px;" class="button-container">
                <a href="/projects/compiler" class="button">Compiler</a>
                <a href="/projects/chess" class="button">Chess</a>
                <a href="/projects/malware-analysis" class="button">Malware Analysis</a>
                <a href="/projects/geo-spoofing-detection" class="button">Geo-Spoofing Detection</a>
                <a href="/projects/personal-website" class="button">Personal Website</a>
                <a href="/projects/code-injection" class="curbutton">Code Injection</a>
            </div>
        </nav></div>
    </header>
    <div style="margin-top: 110px;"class="terminal">
        <h1>Code Injection / Virus</h1>
        <div style="flex-direction:row"><a href="https://github.com/JasonHarrisonSchwartzman/ELF-Code-Injection" class="github-button" target="_blank">
                <i class="fab fa-github icon"></i>GitHub Source Code</a>
                <a href="https://github.com/JasonHarrisonSchwartzman/Chess/archive/refs/heads/master.zip" class="github-button" download>
                    <i class="fas fa-download icon"></i>VM with Virus 
                </a>
            <a href="/projects/code-injection/timestamps" class="button" target="_blank">Timestamps</a>
            </div>
        <p>Start Date: October 2023</p>
        <p>Status: In progress</p>
        <p>The project's objective is to create a virus that infects all executables 
            in the target directory. When those executables are ran the virus's payload runs before the normal program. 
            Attempting to insert code into the main function of the ELF file will corrupt the ELF file most likely causing it to seg fault. 
            However, injecting it to a precise location and changing a few values in the ELF file as well, we can accomplish this goal.
        </p>
        <h2>
            Virus Payload
        </h2>
        <p>This virus contains a payload that will send an HTTP POST request to this web server. The web server logs the time and date in a database for users to view. 
            You can see all timestamps <a href="/projects/code-injections/timestamps">here</a>. At the end of the payload an instructions jumps back to the start of the program, and begins to execute.</p>
        <h2>
            Virus Infection Method
        </h2>
        <p>
            In order to add the payload to the targeted file, we must first edit values that will both allow the virus to run while also preserving the original functionality of the code.
            First, we need to find a place to inject the code so that it doesn't interfere with any other segment. Most ELF files contain segments of executable code with amounts of room between the end of this segment and another segment.
            If there is enough virtual address space that fits the size of the payload we can inject it into this location. 
            Most ELF files have sections padded with zeros at the end of the data for that section. 
            This is due to the fixed sized of pages in page tables which are usually 4096 (0x1000) bytes. 
            When the program gets loaded into memory it segments get loaded into memory or in this case page tables. 
            Knowing this, we can inject the payload starting at the end of the last section loaded into the execution segment by changing the bytes, so they represent the correct instructions.
            Then, we change the memory size and file size of the execution segment so our payload also gets loaded into memory.
            </p>
            <img style="width:500px" src="/images/programheader.png">
            <p></p>
            <p>Here we can see the segment that contains executable code. It's virtual address range is from 0x1000 to 0x1245. The next segment that gets loaded into memory begins at virtual address 0x2000 leaving 0xdbb space open.
         
            </p>
            <img style="width:500px" src="/images/sectionheader.png">  
            <p></p>
            <p>This is the last section that contains executable code. The end of the section is at 0x1245 which is where we will inject the code.</p>
            <p>The last instruction of our payload needs to point to the original entry point of the infected file so we calculate this too.</p>
            <div class="code-container"><pre><code><span style="color:blue">length_of_code_injection</span> = 0x27b 
<span style="color:blue">instruction_pointer</span><span style="color:white"> =</span> <span style="color:blue">inject_offset</span><span style="color:white"> + </span><span style="color:blue">length_of_code_injection</span>
<span style="color:blue">jmp_to_start_operand</span><span style="color:white"> =</span> 0xffffffff <span style="color:white">+ </span>1 <span style="color:white">-</span> <span style="color:orange">abs</span><span style="color:white">(</span><span style="color:blue">OLD_ENTRY_POINT</span><span style="color:white"> -</span> <span style="color:blue">instruction_pointer</span><span style="color:white">)</span></code></pre></div>
</p>
<p>           
Lastly, we change the entry point to point to the location of the payload.
            insert pic
            And we're done!
        </p>
            <h2>Download</h2>
        <p>You can download and run the virus in the given VM (recommended) or download the virus as is.</p>
        <h2>Usage</h2>
        <p>In the current directory where the virus is installed enter: python3 inject.py in the terminal.</p>
            <h2>Development Process</h2>
            <p>With ELF files, you are unable to simply put the code in the text section of the ELF. This will cause the program to segfault. Other edits are necessary.</p>
            <p>To solve this, I researched the format of ELF files and determined most of the problem was coming from misaligned offets due to the change of size in the file.
            My first step was to succesfully inject code into a hello world program.
            </p>
            <p> 
                There are multiple places one can inject the malicious code. I did some experimentation with injecting code directly into the .text section of code specifically the main function. 
                I was able to determine what offsets and values needed to be changed in order to prevent the file from corrupting.
                However, this method would prove to be invalid as sometimes the virtual address that I changed were used in computations within the code section that now yield different answers.
            </p>
            <h2>Timestamps</h2>

            <p>The timestamps you see include all times the injected code ran successfully in an effected file. This is the only information that can be displayed as the virus does not capture any info. You can run the effected application and then view this page to see a timestamps that should match when you started the program if the code was succesfully ran.</p>
        </div>
</body>
</html>
